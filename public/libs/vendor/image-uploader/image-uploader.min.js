/*!
 * Image Uploader Plugin for Twitter Bootstrap
 *
 * Copyright 2014 FoodToEat, Phil Condreay (phil@foodtoeat.com)
 *
 * For the full copyright and license information, please view the
 * LICENSE file that was distributed with this source code.
 */
(function(e,i,t,a){"use strict";var r=function(i,t){this.$el=e(i);for(var a in r.defaults)this[a]=t[a];this._init()};r.defaults={src:a,name:"image",height:300,width:300},r.prototype={constructor:r,file_reader:i.FileReader?new FileReader:a,$:function(e){return this.$el.find(e)},_init:function(){var e=this;e.template=['<div class="image-upload-wrapper ',e.file_reader?"":"no-support",'" ','style="width:',e.width,"px; height:",e.height,'px">','<div class="overlay shadowed upload">','<input type="file" name="',e.name,'" accept="image/*">','<div class="bottom">','<button type="button" class="btn btn-primary" data-action="upload">','<span class="glyphicon glyphicon-cloud-upload"></span>',"Upload","</button>","</div>","</div>",'<div class="overlay confirm-dialog">','<div class="bottom">',"<div>",'<button type="button" class="btn btn-danger" data-action="upload-cancel">','<span class="glyphicon glyphicon-remove"></span>',"</button>",'<button type="button" class="btn btn-success" data-action="upload-confirm">','<span class="glyphicon glyphicon-ok"></span>',"</button>","</div>","</div>","</div>",'<div class="overlay shadowed loader">','<div class="bottom">','<div class="loading-image"></div>',"</div>","</div>",'<div class="overlay shadowed errored">','<div class="bottom">','<div data-container="error-text">Error!</div>','<button class="btn btn-danger" data-action="error-ok">Ok</button>',"</div>","</div>",'<div class="overlay unsupported">','<div class="bottom">Your browser doesn\'t support Image Uploader</div>',"</div>",'<img class="preview" data-conatiner="preview">',"</div>"].join(""),e.$el.html(e.template).on("click","[data-action=upload]",function(i){i.preventDefault(),e.$('input[type="file"]').click()}).on("change",'input[type="file"]',function(){var i=e.$(".image-upload-wrapper");this.files&&this.files[0]&&(e.previewFile(this.files[0]),e.$el.trigger("imageUploader.change",this.files[0]),i.addClass("confirming"))}).on("click","[data-action=upload-cancel]",function(i){i.preventDefault(),e.$(".image-upload-wrapper").removeClass("confirming"),e.revert(),e.$el.trigger("imageUploader.cancel")}).on("click","[data-action=upload-confirm]",function(i){i.preventDefault(),e.$(".image-upload-wrapper").removeClass("confirming"),e.$el.trigger("imageUploader.confirm",e.$('input[type="file"]')[0].files[0])}).on("click","[data-action=error-ok]",function(i){i.preventDefault(),e.$(".image-upload-wrapper").removeClass("errored")}),e.setFile({success:function(){e.previewFile(e.file)}})},setFile:function(e){var i=this;if(!i.src)throw"ImageUploader requires a src attribute.";var t=new XMLHttpRequest;t.open("GET",i.src,!0),t.responseType="blob",t.onload=function(){if(200!=this.status)throw"Couldn't find url ("+url+").";i.file=this.response,e&&"success"in e&&e.success()},t.send()},previewFile:function(e){var i=this,t=i.$(".preview");i.preview_file=e,i.file_reader.onload=function(e){t.attr("src",e.target.result),i.cropImage(t)},i.file_reader.readAsDataURL(e)},cropImage:function(e){e.css({width:"initial",height:"initial"});var i,t,a=e.height(),r=e.width(),o=a/r,n=this.height/this.width;a/r>n?(i=Math.floor(this.width*o),t=this.width):(i=this.height,t=Math.floor(this.height/o)),e.css({height:i+"px",width:t+"px","margin-left":-(t-this.width)/2+"px","margin-top":-(i-this.height)/2+"px"})},loading:function(){this.$(".image-upload-wrapper").addClass("loading")},saved:function(){this.$(".image-upload-wrapper").removeClass("loading"),this.file=this.preview_file},error:function(e){this.$(".image-upload-wrapper").removeClass("loading"),this.$(".image-upload-wrapper").addClass("errored"),this.revert(),this.$el.find("[data-container=error-text]").html(e)},revert:function(){this.previewFile(this.file),this.$('input[type="file"]').val("")}},e.fn.imageUploader=function(i){var t=Array.apply(null,arguments);return t.shift(),this.each(function(){var a=e(this),o=a.data("imageUploader"),n="object"==typeof i&&i;o||a.data("imageUploader",o=new r(this,e.extend({},r.defaults,n,a.data()))),"string"==typeof i&&o[i].apply(o,t)})}})(jQuery,window,document);